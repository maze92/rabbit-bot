<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ozark Bot Dashboard</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body { font-family: sans-serif; background: #1e1e1e; color: #eee; padding: 20px; }
  h1 { color: #e60012; }
  input, select { padding: 5px; margin: 5px; background: #333; color: #eee; border: none; }
  .log { border-bottom: 1px solid #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; }
  .title { font-weight: bold; }
  .desc { margin-left: 10px; display: block; }
</style>
</head>
<body>
  <h1>Ozark Bot Dashboard</h1>

  <div>
    <input type="text" id="searchUser" placeholder="Search by user/executor...">
    <select id="filterType">
      <option value="">All types</option>
      <option value="warn">Warn</option>
      <option value="mute">Mute</option>
      <option value="clear">Clear</option>
      <option value="game news">Game News</option>
      <option value="anti-spam">Anti-Spam</option>
    </select>
  </div>

  <div id="logs"></div>

  <script>
    // ------------------------------------------------------------
    // Dashboard auth token
    // Abre o dashboard assim:
    // https://teuapp.railway.app/?token=TEU_DASHBOARD_TOKEN
    // ------------------------------------------------------------
    const params = new URLSearchParams(window.location.search);
    const token = params.get('token');

    if (!token) {
      document.body.innerHTML = '<h2 style="color:#ffcc00;">Missing token</h2><p>Add <b>?token=YOUR_TOKEN</b> in the URL.</p>';
      throw new Error('Missing token');
    }

    const socket = io({
      auth: { token }
    });

    const logsContainer = document.getElementById('logs');
    const searchInput = document.getElementById('searchUser');
    const filterSelect = document.getElementById('filterType');

    let allLogs = [];

    function renderLogs(logs) {
      logsContainer.innerHTML = '';
      logs.slice().reverse().forEach(log => {
        const div = document.createElement('div');
        div.classList.add('log');

        const color = getColor(log.title || '');
        div.style.borderLeft = `5px solid ${color}`;

        const userTag = log.user?.tag || 'N/A';
        const execTag = log.executor?.tag || 'N/A';
        const time = log.time ? new Date(log.time).toLocaleString() : '';

        div.innerHTML = `
          <span class="title">${escapeHtml(log.title || 'Log')}</span> 
          <span class="desc">${escapeHtml(log.description || '')}</span>
          <small>üë§ User: ${escapeHtml(userTag)} | üõ† Executor: ${escapeHtml(execTag)} | ‚è∞ ${escapeHtml(time)}</small>
        `;
        logsContainer.appendChild(div);
      });
    }

    function getColor(title) {
      title = String(title).toLowerCase();
      if (title.includes('warn')) return '#ffcc00';
      if (title.includes('mute')) return '#ff6600';
      if (title.includes('clear') || title.includes('purge')) return '#00ccff';
      if (title.includes('game news')) return '#e60012';
      if (title.includes('anti-spam')) return '#cc00ff';
      return '#00ff00';
    }

    function filterLogs() {
      const search = searchInput.value.toLowerCase();
      const type = filterSelect.value.toLowerCase();

      const filtered = allLogs.filter(log => {
        const u = log.user?.tag?.toLowerCase() || '';
        const e = log.executor?.tag?.toLowerCase() || '';
        const matchesUser = u.includes(search) || e.includes(search);

        const t = (log.title || '').toLowerCase();
        const matchesType = type ? t.includes(type) : true;

        return matchesUser && matchesType;
      });

      renderLogs(filtered);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    socket.on('connect', () => {
      socket.emit('requestLogs');
    });

    socket.on('connect_error', (err) => {
      document.body.innerHTML = '<h2 style="color:#ff6666;">Unauthorized</h2><p>Invalid token.</p>';
      console.error(err);
    });

    socket.on('logs', logs => {
      allLogs = Array.isArray(logs) ? logs : [];
      filterLogs();
    });

    searchInput.addEventListener('input', filterLogs);
    filterSelect.addEventListener('change', filterLogs);

    setInterval(() => {
      socket.emit('requestLogs');
    }, 5000);
  </script>
</body>
</html>
